<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WhalaApp ‚Äî B-Eye-O-Marker V1 + WhalaBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0b14" />
  <meta name="description" content="WhalaApp: AI eye health (CNN) + accessible chatbot with TTS and planning."/>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root {
      --bg:#0b0b14; --bg-soft:#0f1120; --text:#f7f7fb; --muted:#b9b9c9;
      --brand:#7ad8ff; --brand-2:#b07cff; --accent:#64ffa1; --danger:#ff5a84; --focus:#ffe084;
      --card:rgba(255,255,255,0.06); --radius-xl:22px; --radius-xxl:30px; --shadow-1:0 10px 30px rgba(0,0,0,0.25); --shadow-2:0 20px 60px rgba(0,0,0,0.4);
      --speed-1:800ms; --speed-2:1400ms; --speed-3:2200ms; --font-sans: ui-sans-serif, system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; --font-mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font-sans); color:var(--text);
      background: radial-gradient(1200px 800px at 10% -10%, rgba(122,216,255,0.12), transparent 55%),
                  radial-gradient(1200px 800px at 110% 10%, rgba(176,124,255,0.12), transparent 55%),
                  radial-gradient(900px 600px at 50% 120%, rgba(100,255,161,0.08), transparent 60%), var(--bg);
      overflow-x:hidden;
    }
    header{position:sticky; top:0; z-index:1000; backdrop-filter:saturate(1.2) blur(10px);
      background:linear-gradient(180deg, rgba(11,11,20,0.78), rgba(11,11,20,0.44));
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .nav{max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:14px 20px;}
    .brand{display:flex; align-items:center; gap:12px; color:var(--text); text-decoration:none;}
    .brand img{width:42px;height:42px;border-radius:10px;object-fit:contain;background:rgba(255,255,255,0.04);padding:6px}
    .brand strong{letter-spacing:.6px;font-weight:800}
    .ctrls{display:flex;gap:10px}
    .btn{border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.04); color:var(--text);
      padding:8px 12px; border-radius:12px; cursor:pointer; font-size:14px; font-weight:700;}
    .btn:focus{outline:3px solid var(--focus); outline-offset:2px}

    main{max-width:1200px; margin:0 auto; padding:28px 20px 80px}
    h1{font-size:clamp(30px,6vw,56px); margin:18px 0}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:24px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border:1px solid rgba(255,255,255,0.12); border-radius:var(--radius-xxl); box-shadow:var(--shadow-1);
      padding:18px; position:relative; overflow:hidden}
    .panel h2{margin:0 0 8px; font-size:24px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .well{background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:10px 12px}
    .media{display:grid; grid-template-columns: 1.1fr 0.9fr; gap:16px}
    .media .ph{background:var(--card); border:1px solid rgba(255,255,255,0.12); border-radius:16px; min-height:260px; display:grid; place-items:center; position:relative; overflow:hidden}
    video, canvas {max-width:100%; width:100%; border-radius:16px}
    input[type="file"]{display:none}
    label.file{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.06); cursor:pointer; font-weight:700}
    .primary{background:linear-gradient(135deg, var(--brand), var(--accent)); color:#042016; border:0}
    .danger{background:linear-gradient(135deg,#ff98b1,#ff5a84); color:#3e0014; border:0}
    .kpi{display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top:10px}
    .kpi .box{background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:12px; padding:10px}
    .mono{font-family:var(--font-mono)}
    .out{background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:12px; min-height:120px}
    .chat{display:grid; grid-template-rows:auto 1fr auto; gap:12px; height:520px}
    .msgs{overflow:auto; border:1px solid rgba(255,255,255,0.12); border-radius:14px; padding:12px; background:rgba(255,255,255,0.05)}
    .msg{margin:8px 0; line-height:1.6}
    .msg.user{color:#dfe8ff}
    .msg.bot{color:#eafff2}
    .plan{background:rgba(100,255,161,0.08); border:1px solid rgba(100,255,161,0.25); border-radius:14px; padding:8px 10px; margin:10px 0}
    .actions{display:flex; gap:10px}
    .sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
    .tts-on{outline:3px solid var(--focus)}
    .chart-wrap{border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:10px; background:rgba(255,255,255,0.05)}
    small.warn{color:#ffd2e0}
    .disclaimer{margin-top:12px; color:#ffd2e0; font-size:13px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .media{grid-template-columns:1fr} }
    @media (prefers-reduced-motion: reduce){ *{animation:none!important;transition:none!important} }
  </style>
</head>
<body>
  <header role="banner" aria-label="Main Navigation">
    <nav class="nav" aria-label="Primary">
      <a class="brand" href="index.html"><img src="logo.png" alt="Whala logo"/><strong>Whala</strong></a>
      <div class="ctrls">
        <button class="btn" id="toggleTTS" aria-pressed="true" title="Toggle screen-reader voice">üîä Voice</button>
        <button class="btn" id="highContrast" title="High Contrast">‚¨õ‚¨ú</button>
        <button class="btn" id="largerText" title="A+ Text">A+</button>
      </div>
    </nav>
  </header>

  <main id="main" tabindex="-1">
    <h1 class="tts">WhalaApp ‚Äî B-Eye-O-Marker V1 + WhalaBot</h1>

    <section class="grid">
      <!-- CNN PANEL -->
      <section class="panel" aria-labelledby="cnn-h">
        <h2 id="cnn-h" class="tts">B-Eye-O-Marker V1 (CNN)</h2>
        <p class="muted tts">Upload a retinal/OCT image of an eye, or capture via camera. The model classifies **DR vs DME** with calibrated uncertainty. You can also skip and enter a condition manually.</p>

        <div class="media" style="margin-top:10px">
          <div class="ph">
            <video id="cam" playsinline class="sr-only" aria-hidden="true"></video>
            <canvas id="frame" width="512" height="512" aria-label="Image preview"></canvas>
          </div>
          <div>
            <div class="row">
              <input id="file" type="file" accept="image/*" />
              <label for="file" class="file" aria-label="Choose a photo">üìÅ Choose Photo</label>
              <button class="btn" id="openCam" aria-pressed="false">üì∑ Use Camera</button>
              <button class="btn primary" id="run" disabled>‚ñ∂Ô∏è Run CNN</button>
              <button class="btn danger" id="reset">‚ôª Reset</button>
            </div>

            <div class="kpi" style="margin-top:10px">
              <div class="box"><div class="muted">Predicted</div><div id="pred" class="mono tts">‚Äî</div></div>
              <div class="box"><div class="muted">Confidence</div><div id="conf" class="mono tts">‚Äî</div></div>
              <div class="box"><div class="muted">Uncertainty</div><div id="unc" class="mono tts">‚Äî</div></div>
            </div>

            <div class="well" style="margin-top:10px">
              <label for="manual" class="muted">Or type a condition (skip CNN):</label>
              <input id="manual" class="mono" placeholder="e.g., Normal, DR, DME, Glaucoma, AMD‚Ä¶" style="width:100%;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.04); color:var(--text)" />
            </div>
          </div>
        </div>

        <div class="chart-wrap" style="margin-top:12px">
          <canvas id="bars" width="800" height="140" aria-label="Class probabilities chart"></canvas>
        </div>

        <p class="disclaimer tts"><strong>Important:</strong> This is a research preview, not a medical device. Don‚Äôt use for diagnosis or treatment decisions. If you have any symptoms, seek professional care or call emergency services.</p>
      </section>

      <!-- CHATBOT PANEL -->
      <section class="panel chat" aria-labelledby="bot-h">
        <h2 id="bot-h" class="tts">WhalaBot ‚Äî Accessible Health Advisor</h2>
        <div id="msgs" class="msgs" role="log" aria-live="polite" aria-relevant="additions"></div>
        <div class="plan tts" id="planBox" aria-live="polite"></div>
        <div class="actions">
          <input id="chat" placeholder="Ask anything‚Ä¶ (Enter to send)" aria-label="Type message" style="flex:1; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.06); color:var(--text)" />
          <button class="btn primary" id="send">Send</button>
        </div>
        <small class="warn tts">Privacy: your message and (if provided) the model‚Äôs classification are sent to our server to generate tailored guidance. We don‚Äôt store images.</small>
      </section>
    </section>
  </main>

  <!-- onnxruntime-web (GPU/WebGL if available; falls back to WASM) -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/ort.min.js" integrity="sha384-6m8n1Gk8P8T2U3cBz6yRug0YjD8JgqGxk6w2G8c0y+f6IpR1oP6wCJ1TtWlKxW9C" crossorigin="anonymous"></script>
  <script>
    // --------------- Accessibility: global TTS for *every* section ---------------
    let TTS_ON = true;
    const synth = window.speechSynthesis;
    function speak(el){
      if(!TTS_ON || !synth) return;
      const text = (typeof el === 'string') ? el : (el.innerText || el.textContent || '');
      if(!text || !text.trim()) return;
      const u = new SpeechSynthesisUtterance(text.trim());
      u.rate = 1.03; u.pitch = 1.0; u.volume = 1; u.lang = navigator.language || 'en-US';
      synth.cancel(); // read last only
      synth.speak(u);
    }
    function ttsAll(){
      document.querySelectorAll('.tts').forEach((el,i)=>{ if(i<1) speak(el); });
    }
    window.addEventListener('load', ttsAll);

    document.getElementById('toggleTTS').addEventListener('click', e=>{
      TTS_ON = !TTS_ON;
      e.currentTarget.setAttribute('aria-pressed', String(TTS_ON));
      e.currentTarget.classList.toggle('tts-on', TTS_ON);
      speak(TTS_ON ? "Voice on" : "Voice off");
    });
    document.getElementById('highContrast').addEventListener('click', ()=>{
      const r = document.documentElement;
      const hc = r.style.getPropertyValue('--bg') === '#000';
      r.style.setProperty('--bg', hc ? '#0b0b14' : '#000');
      r.style.setProperty('--text', hc ? '#f7f7fb' : '#fff');
      r.style.setProperty('--muted', hc ? '#b9b9c9' : '#eaeaea');
      speak('Contrast toggled');
    });
    document.getElementById('largerText').addEventListener('click', ()=>{
      const body = document.body;
      const big = body.style.fontSize === '18px';
      body.style.fontSize = big ? '' : '18px';
      speak('Text size toggled');
    });

    // --------------- CNN: load ONNX model + preprocess/infer ---------------------
    const onnxPath = 'b_eye_o_marker_v1.onnx'; // keep alongside this file
    let session = null;
    let lastProbs = [0.5, 0.5];
    let lastPred = null;

    const file = document.getElementById('file');
    const frame = document.getElementById('frame');
    const cam = document.getElementById('cam');
    const openCam = document.getElementById('openCam');
    const runBtn = document.getElementById('run');
    const resetBtn = document.getElementById('reset');
    const ctx = frame.getContext('2d', { willReadFrequently: true });

    let usingCamera = false;
    let stream = null;

    async function loadModel(){
      if(session) return session;
      try{
        session = await ort.InferenceSession.create(onnxPath, {
          executionProviders: ['webgl','wasm'], graphOptimizationLevel: 'all'
        });
        speak('Model loaded');
      }catch(err){
        console.error(err); alert('Failed to load ONNX model. Ensure b_eye_o_marker_v1.onnx is present.');
      }
      return session;
    }
    function drawImageToCanvas(img){
      const size = Math.min(frame.width, frame.height);
      // letterbox center-crop
      const ratio = Math.min(frame.width/img.width, frame.height/img.height);
      const w = img.width * ratio, h = img.height * ratio;
      ctx.clearRect(0,0,frame.width,frame.height);
      ctx.drawImage(img, (frame.width-w)/2, (frame.height-h)/2, w, h);
      runBtn.disabled = false;
    }
    file.addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      const img = new Image(); img.onload = ()=>drawImageToCanvas(img); img.src = url;
      usingCamera = false; closeCam();
    });

    openCam.addEventListener('click', async ()=>{
      try{
        if(usingCamera){ closeCam(); return; }
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }, audio:false });
        cam.srcObject = stream; cam.classList.remove('sr-only'); cam.play();
        usingCamera = true; openCam.setAttribute('aria-pressed','true');
        requestAnimationFrame(captureToCanvas);
        runBtn.disabled = false;
        speak('Camera on');
      }catch(err){ console.error(err); alert('Camera access denied.'); }
    });
    function captureToCanvas(){
      if(!usingCamera) return;
      ctx.drawImage(cam, 0, 0, frame.width, frame.height);
      requestAnimationFrame(captureToCanvas);
    }
    function closeCam(){
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      cam.pause(); cam.srcObject=null; cam.classList.add('sr-only'); usingCamera=false;
      openCam.setAttribute('aria-pressed','false');
    }
    resetBtn.addEventListener('click', ()=>{
      ctx.clearRect(0,0,frame.width,frame.height); runBtn.disabled=true; file.value='';
      document.getElementById('pred').textContent='‚Äî'; document.getElementById('conf').textContent='‚Äî'; document.getElementById('unc').textContent='‚Äî';
      drawBars([0,0]);
      speak('Reset');
    });

    function preprocess(){
      // Training transforms were: Grayscale‚ÜíResize(224√ó224)‚ÜíToTensor() in [0,1]
      const size = 224;
      const tmp = document.createElement('canvas'); tmp.width=size; tmp.height=size;
      const tctx = tmp.getContext('2d');
      tctx.drawImage(frame, 0,0,size,size);
      const {data} = tctx.getImageData(0,0,size,size);
      const x = new Float32Array(1*1*size*size);
      for(let i=0;i<size*size;i++){
        const r = data[i*4]/255, g=data[i*4+1]/255, b=data[i*4+2]/255;
        // grayscale like transforms.Grayscale: luminosity approx
        const gray = 0.2989*r + 0.5870*g + 0.1140*b;
        x[i] = gray;
      }
      return new ort.Tensor('float32', x, [1,1,size,size]);
    }

    function softmax(logits){
      const m = Math.max(...logits), exps = logits.map(v=>Math.exp(v-m));
      const s = exps.reduce((a,b)=>a+b,0);
      return exps.map(v=>v/s);
    }

    function drawBars(p){
      const c = document.getElementById('bars');
      const cx = c.getContext('2d');
      cx.clearRect(0,0,c.width,c.height);
      const labels = ['DR','DME'];
      const W = c.width, H=c.height, pad=20, bw= (W-2*pad)/labels.length - 30;
      labels.forEach((lab,i)=>{
        const x = pad + i*(bw+30);
        const h = Math.max(2, (H-40)*p[i]);
        cx.fillStyle='rgba(122,216,255,0.35)'; cx.fillRect(x, H-20-h, bw, h);
        cx.fillStyle='#fff'; cx.fillText(`${lab}: ${(p[i]*100).toFixed(1)}%`, x, H-6);
      });
    }

    async function runCNN(){
      await loadModel();
      const input = preprocess();
      const feeds = {'input': input}; // expects name "input"; if different, quick-map below:
      let out;
      try{
        out = await session.run(feeds);
      }catch(e){
        // Fallback: try first output if unknown name
        const outNames = session.outputNames;
        out = await session.run(feeds, outNames ? outNames : undefined);
      }
      const firstKey = Object.keys(out)[0];
      const logits = Array.from(out[firstKey].data);
      const probs = softmax(logits);
      lastProbs = probs;
      const classes = ['DR','DME'];
      const predIdx = probs[0] >= probs[1] ? 0 : 1;
      lastPred = classes[predIdx];

      const conf = probs[predIdx];
      const uncertainty = 1 - conf;
      document.getElementById('pred').textContent = lastPred;
      document.getElementById('conf').textContent = `${(conf*100).toFixed(1)}%`;
      document.getElementById('unc').textContent  = `${(uncertainty*100).toFixed(1)}%`;
      drawBars(probs);

      // Accessibility voice
      speak(`Predicted ${lastPred} with confidence ${(conf*100).toFixed(1)} percent`);

      // Auto-seed WhalaBot with the new result
      seedPlanAndAdvice();
    }

    document.getElementById('run').addEventListener('click', runCNN);

    // --------------- Chatbot: talks to our backend, which does MCTS + OpenAI ----
    const msgs = document.getElementById('msgs');
    const planBox = document.getElementById('planBox');
    function pushMsg(role, text){
      const div = document.createElement('div');
      div.className = 'msg ' + (role === 'user' ? 'user' : 'bot') + ' tts';
      div.textContent = text;
      msgs.appendChild(div);
      msgs.scrollTop = msgs.scrollHeight;
      speak(text);
    }

    async function seedPlanAndAdvice(){
      const manual = document.getElementById('manual').value?.trim();
      const condition = manual || lastPred || 'Unknown';
      const body = {
        condition,
        cnn: {pred:lastPred, probs:lastProbs},
        user: { goals: ['protect vision','improve accessibility','reduce risk'] }
      };
      try{
        const r = await fetch('/api/plan_and_chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if(!r.ok) throw new Error('Server error');
        const data = await r.json();

        // Render plan summary
        planBox.textContent = `Plan selected via MCTS: ${data.plan.title} ‚Äî ${data.plan.summary}`;
        speak(planBox);

        // Render charts/metrics
        drawBars(data.chart?.classProbs || lastProbs);
        // Add bot intro
        pushMsg('bot', data.intro || 'I\'m ready to help. What would you like to know?');
      }catch(e){
        console.error(e);
        pushMsg('bot', 'Could not generate plan right now, but you can still ask me questions.');
      }
    }

    document.getElementById('send').addEventListener('click', sendChat);
    document.getElementById('chat').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); }});
    async function sendChat(){
      const input = document.getElementById('chat');
      const text = input.value.trim(); if(!text) return;
      input.value=''; pushMsg('user', text);

      const manual = document.getElementById('manual').value?.trim();
      const condition = manual || lastPred || 'Unknown';
      const body = {
        condition,
        cnn: {pred:lastPred, probs:lastProbs},
        message: text
      };
      try{
        const r = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if(!r.ok) throw new Error('Server error');
        const data = await r.json();
        pushMsg('bot', data.reply);
        if(data.plan){ planBox.textContent = `Plan: ${data.plan.title} ‚Äî ${data.plan.summary}`; speak(planBox); }
      }catch(e){
        console.error(e);
        pushMsg('bot', 'Trouble reaching the advisor right now. Please try again.');
      }
    }

    // --------------- enable Run CNN when something is on canvas -----------------
    frame.addEventListener('draw', ()=> runBtn.disabled=false); // (synthetic if needed)

    // --------------- kick-off: preload model quietly ----------------------------
    (async ()=>{ try{ await loadModel(); }catch(_){} })();
  </script>
</body>
</html>
