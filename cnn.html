<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>B-Eye-O-Marker ‚Äî CNN-V2 (BiNLOP-3)</title>
<meta name="description" content="Accessible, TTS-enabled retinal analysis demo using B-Eye-O-Marker_CNN-V2 (BiNLOP-3) ONNX." />
<!-- Chart.js (for accessible visualizations; table is provided for screen readers) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha256-s3z7uLQe2jF7m9uN0uOAhjHLtPq4dPSmabnxyOV9B6o=" crossorigin="anonymous"></script>
<!-- ONNX Runtime Web (WASM; widely supported) -->
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js" integrity="sha256-7z+u6QWT9P4gH1o8p6Q1mTv1QX+/dO1VfWOu2+Y1WJs=" crossorigin="anonymous"></script>
<style>
  :root{
    --bg: #0b1020; --panel:#11162b; --panel-2:#0d1226; --text:#e7ecff; --muted:#9fb0ff;
    --accent:#7aa2ff; --accent-2:#5ce1e6; --good:#6be675; --warn:#ffd166; --bad:#ff6b6b;
    --focus:#ffe27a; --border:#1f2a48; --shadow: rgba(0,0,0,0.35);
    --radius: 16px; --radius-sm: 12px;
  }
  [data-contrast="high"]{
    --bg:#000; --panel:#050505; --panel-2:#0a0a0a; --text:#fff; --muted:#ccc; --accent:#00e; --accent-2:#0aa;
    --focus:#ff0; --border:#444;
  }
  @media (prefers-reduced-motion: reduce){
    *{ animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration:0.01ms !important; scroll-behavior:auto !important; }
  }
  html,body{height:100%}
  body{
    margin:0; background: radial-gradient(1200px 900px at 10% 0%, #12193a, var(--bg)) fixed;
    color:var(--text); font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
  }
  .container{max-width:1200px;margin:0 auto;padding:24px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 6px 22px var(--shadow)}
  h1{font-weight:800;letter-spacing:0.4px;margin:0}
  .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 10px 30px var(--shadow)}
  .panel .content{padding:18px}
  nav.tabs{display:flex;gap:6px;flex-wrap:wrap;padding:6px}
  .tab{cursor:pointer;border:none;background:transparent;color:var(--muted);padding:10px 14px;border-radius:12px;transition:all .2s}
  .tab[aria-selected="true"]{background:linear-gradient(180deg,#1a2142,#0f1634);color:var(--text);box-shadow:0 6px 18px var(--shadow)}
  .grid{display:grid;gap:16px}
  @media(min-width:960px){ .grid.cols-2{grid-template-columns:1.1fr 1fr} .grid.cols-3{grid-template-columns:1fr 1fr 1fr} }
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{
    background:linear-gradient(180deg,#1f2a52,#152045); border:1px solid var(--border); color:var(--text);
    padding:10px 14px; border-radius:12px; cursor:pointer; transition:transform .05s ease, box-shadow .2s;
  }
  .btn:hover{box-shadow:0 8px 24px var(--shadow)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(180deg,var(--accent),#456bff); color:#08102a; font-weight:700}
  .btn.warn{background:linear-gradient(180deg,#573116,#2a140b); border:1px solid #6a3b1a}
  input[type="file"], input[type="text"], select{
    background:#0b1230;border:1px solid var(--border);color:var(--text);padding:10px;border-radius:10px
  }
  label{display:block;margin-bottom:6px;color:var(--muted)}
  .kbd{background:#0a1030;border:1px solid var(--border); padding:2px 6px; border-radius:8px}
  .card{padding:14px;border-top:1px solid var(--border)}
  .sr-only{position:absolute!important; width:1px!important; height:1px!important; padding:0!important; margin:-1px!important; overflow:hidden!important; clip:rect(0,0,0,0)!important; white-space:nowrap!important; border:0!important;}
  .live{position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:100px; border:1px solid var(--border); background:#0a1230; color:var(--muted); font-size:12px}
  .meter{height:10px;background:#0b122a;border-radius:100px;border:1px solid var(--border); overflow:hidden}
  .meter > span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
  .warning{color:var(--warn)}
  .danger{color:var(--bad)}
  .good{color:var(--good)}
  footer{opacity:.9;margin-top:22px}
  .flex{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
  .wide{width:100%}
  .chart-wrap{position:relative;min-height:280px}
  .kbd-row{display:flex;gap:10px;flex-wrap:wrap}
  .vis{border-radius:12px;background:#060a1a; border:1px solid var(--border); padding:8px}
  .img-preview{width:100%;max-height:420px;object-fit:contain;border-radius:12px;border:1px solid var(--border);background:#050a18}
  .video{width:100%;max-height:420px;border-radius:12px;border:1px solid var(--border);background:#050a18}
  .section-title{display:flex;align-items:center;gap:8px;margin:0 0 8px 0}
  .section-title h2{margin:0}
  a, button, input, select, textarea{outline-color: var(--focus); outline-offset: 2px}
</style>
</head>
<body data-contrast="normal">
<a href="#main" class="sr-only">Skip to main content</a>
<div class="container">
  <header aria-label="Application header">
    <div class="brand" role="img" aria-label="B-Eye-O-Marker logo">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>B-Eye-O-Marker ‚Äî CNN-V2 (BiNLOP-3)</h1>
        <div class="kbd-row" aria-hidden="true">
          <span class="pill">Client-side ONNX</span>
          <span class="pill">Accessible + TTS</span>
          <span class="pill">Camera / Upload / Manual</span>
        </div>
      </div>
    </div>
    <div class="controls" role="group" aria-label="Accessibility controls">
      <button class="btn" id="ttsToggle" aria-pressed="false" aria-label="Toggle text to speech">üîä TTS: Off</button>
      <button class="btn" id="contrastToggle" aria-pressed="false" aria-label="Toggle high contrast">üåì High Contrast</button>
      <label class="sr-only" for="fontSize">Text size</label>
      <select id="fontSize" aria-label="Text size">
        <option value="16">Text: 100%</option>
        <option value="18">Text: 112%</option>
        <option value="20">Text: 125%</option>
        <option value="22">Text: 138%</option>
      </select>
      <button class="btn" id="stopTTS" aria-label="Stop speech">‚èπ Stop</button>
    </div>
  </header>

  <!-- Model loader -->
  <section class="panel" aria-labelledby="modelTitle" id="modelPanel">
    <div class="content">
      <div class="section-title">
        <h2 id="modelTitle">1) Load Model</h2>
        <button class="btn" id="readModel" aria-label="Read this section">üîä Read</button>
      </div>
      <p id="modelDesc">Load your ONNX file <strong>B-Eye-O-Marker_CNN-V2.onnx</strong>. All inference runs locally in your browser.</p>
      <div class="controls" role="group" aria-label="Model loading">
        <label for="modelFile">Local ONNX file</label>
        <input type="file" id="modelFile" accept=".onnx" />
        <span>or</span>
        <label class="sr-only" for="modelUrl">Model URL</label>
        <input type="text" id="modelUrl" placeholder="https://your-host/B-Eye-O-Marker_CNN-V2.onnx" size="48" />
        <button class="btn primary" id="loadModelBtn">Load Model</button>
        <span id="modelStatus" role="status" aria-live="polite" class="pill">Model: not loaded</span>
      </div>
      <div class="card">
        <div class="flex">
          <div class="pill" id="prov">Provider: N/A</div>
          <div class="pill" id="opset">Opset: N/A</div>
          <div class="pill" id="graphopt">GraphOpt: N/A</div>
          <div class="pill" id="mem">Memory: N/A</div>
          <div class="pill" id="lat">Last infer: N/A</div>
          <div class="right pill">Threshold: <span id="thrVal">0.50</span></div>
        </div>
        <input type="range" min="0" max="100" value="50" id="thr" class="wide" aria-label="Threshold slider for multi-label decisions" />
      </div>
    </div>
  </section>

  <!-- Modes -->
  <section class="panel" aria-labelledby="modesTitle">
    <div class="content">
      <div class="section-title">
        <h2 id="modesTitle">2) Choose Mode</h2>
        <button class="btn" id="readModes" aria-label="Read this section">üîä Read</button>
      </div>
      <nav class="tabs" role="tablist" aria-label="Input mode tabs">
        <button class="tab" role="tab" id="tabCamera" aria-selected="true" aria-controls="panelCamera">üì∑ Camera</button>
        <button class="tab" role="tab" id="tabUpload" aria-selected="false" aria-controls="panelUpload">üñºÔ∏è Upload Photo</button>
        <button class="tab" role="tab" id="tabManual" aria-selected="false" aria-controls="panelManual">‚úçÔ∏è Manual</button>
      </nav>

      <!-- Camera -->
      <div id="panelCamera" role="tabpanel" aria-labelledby="tabCamera">
        <div class="grid cols-2">
          <div>
            <label for="cameraSelect">Camera device</label>
            <select id="cameraSelect" aria-label="Choose camera"></select>
            <video id="video" class="video" autoplay playsinline muted aria-label="Camera preview"></video>
            <div class="controls">
              <button class="btn" id="startCam">Start Camera</button>
              <button class="btn" id="snap">Take Picture</button>
              <button class="btn" id="analyzeCam">Analyze</button>
              <button class="btn warn" id="stopCam">Stop Camera</button>
            </div>
          </div>
          <div>
            <canvas id="canvasCam" class="img-preview" aria-label="Captured image preview" role="img"></canvas>
            <div class="card">
              <p>Tip: good lighting, hold steady, center the eye. Avoid reflections and motion blur.</p>
            </div>
          </div>
        </div>
      </div>
      <!-- Upload -->
      <div id="panelUpload" role="tabpanel" aria-labelledby="tabUpload" hidden>
        <div class="grid cols-2">
          <div>
            <label for="imgFile">Choose image</label>
            <input type="file" id="imgFile" accept="image/*" />
            <div class="controls">
              <button class="btn" id="analyzeUpload">Analyze</button>
            </div>
          </div>
          <div>
            <img id="imgPreview" class="img-preview" alt="Uploaded image preview" />
          </div>
        </div>
      </div>
      <!-- Manual -->
      <div id="panelManual" role="tabpanel" aria-labelledby="tabManual" hidden>
        <div class="grid cols-2">
          <div>
            <label for="manualSelect">Select your condition (manual mode)</label>
            <select id="manualSelect" aria-label="Manual condition select">
              <option value="">-- Choose a condition --</option>
            </select>
            <div class="controls">
              <button class="btn primary" id="manualExplain">Explain & Recommendations</button>
            </div>
          </div>
          <div class="card">
            <p>This mode does not run the CNN. It provides educational guidance based on your selection.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Results -->
  <main id="main" class="panel" aria-labelledby="resultsTitle">
    <div class="content">
      <div class="section-title">
        <h2 id="resultsTitle">3) Results & Insights</h2>
        <button class="btn" id="readResults" aria-label="Read this section">üîä Read</button>
      </div>

      <!-- Summary -->
      <section aria-labelledby="summaryTitle" class="card">
        <div class="flex">
          <h3 id="summaryTitle" style="margin:0">Summary</h3>
          <button class="btn" id="readSummary" aria-label="Read summary">üîä Read</button>
        </div>
        <div class="grid cols-3">
          <div class="vis">
            <p><strong>Top-1 class:</strong> <span id="topClass">‚Äî</span></p>
            <div class="meter" aria-label="Top confidence meter"><span id="confMeter" style="width:0%"></span></div>
            <p><strong>Confidence:</strong> <span id="topConf">‚Äî</span></p>
            <p><strong>Above threshold (multi-label):</strong> <span id="aboveThr">‚Äî</span></p>
          </div>
          <div class="vis">
            <p><strong>Entropy (lower = certain):</strong> <span id="entropy">‚Äî</span></p>
            <p><strong>Top-1 vs Top-2 gap:</strong> <span id="margin">‚Äî</span></p>
            <p><strong>Latency:</strong> <span id="latency">‚Äî</span></p>
            <p><strong>Provider:</strong> <span id="providerName">‚Äî</span></p>
          </div>
          <div class="vis">
            <p><strong>Image:</strong> <span id="imgInfo">‚Äî</span></p>
            <p><strong>Threshold:</strong> <span id="thrSummary">0.50</span></p>
            <p class="warning"><strong>Important:</strong> This is not a medical device. Not for diagnosis. Consult an eye-care professional.</p>
          </div>
        </div>
      </section>

      <!-- Probabilities -->
      <section aria-labelledby="probsTitle" class="card">
        <div class="flex">
          <h3 id="probsTitle" style="margin:0">Probability Distribution</h3>
          <button class="btn" id="readProbs" aria-label="Read probabilities">üîä Read</button>
        </div>
        <div class="grid cols-2">
          <div class="chart-wrap">
            <canvas id="probChart" aria-label="Probability bar chart"></canvas>
          </div>
          <div>
            <table aria-label="Probabilities table" id="probTable">
              <thead><tr><th scope="col">Class</th><th scope="col">Probability</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Recommendations & Overview -->
      <section aria-labelledby="recsTitle" class="card">
        <div class="flex">
          <h3 id="recsTitle" style="margin:0">Recommendations & Deep Overview</h3>
          <button class="btn" id="readRecs" aria-label="Read recommendations">üîä Read</button>
        </div>
        <div id="recsBody"></div>
      </section>

      <!-- Live region for announcements -->
      <div id="live" class="live" aria-live="polite" aria-atomic="true"></div>
    </div>
  </main>

  <footer>
    <div class="panel">
      <div class="content">
        <p><strong>Safety:</strong> Educational demo only. Not medical advice. If you have symptoms or concerns, seek professional evaluation promptly.</p>
      </div>
    </div>
  </footer>
</div>

<script>
/* ========================= GLOBALS & ACCESSIBILITY ========================= */
const CLASSES = [
  "Normal","DiabeticRetinopathy","DiabeticMacularEdema","AgeRelatedMacularDegeneration",
  "Glaucoma","RetinalDetachment","EpiretinalMembrane","VitreousDetachment","Other"
];
// Educational summaries + tips (kept concise for TTS; expanded in UI):
const EXPLAINS = {
  "Normal": {
    overview: "No strong signals of disease in this image. This does not exclude early or subtle disease.",
    tips: ["Maintain routine eye exams.","Manage blood pressure, blood sugar, and cholesterol.","Use protective eyewear and take screen breaks."]
  },
  "DiabeticRetinopathy": {
    overview: "Findings consistent with diabetic retinopathy risk. Microvascular changes may impact retina.",
    tips: ["Optimize blood glucose, blood pressure, and lipids.","Schedule a comprehensive dilated eye exam.","Report any sudden vision changes immediately."]
  },
  "DiabeticMacularEdema": {
    overview: "Signals suggest possible macular edema related to diabetes; can reduce central vision.",
    tips: ["Urgent clinical assessment is recommended.","Manage systemic risk factors.","Discuss anti-VEGF or laser options with a specialist."]
  },
  "AgeRelatedMacularDegeneration": {
    overview: "Features may align with AMD, which affects central vision via macula.",
    tips: ["Consult on AREDS supplements if appropriate.","Avoid smoking; use UV protection.","Monitor central vision (Amsler grid) and seek care if changes arise."]
  },
  "Glaucoma": {
    overview: "Possible optic nerve or intraocular pressure related risk. Typically requires longitudinal assessment.",
    tips: ["Schedule professional evaluation including pressure and visual fields.","Adhere to prescribed drops if applicable.","Discuss family history."]
  },
  "RetinalDetachment": {
    overview: "Concerning for retinal detachment risk which can threaten vision.",
    tips: ["This warrants urgent, same-day clinical evaluation.","Avoid strenuous activity until cleared.","Note flashes, floaters, or a curtain over vision."]
  },
  "EpiretinalMembrane": {
    overview: "A membrane on the retinal surface may cause distortion.",
    tips: ["Clinical confirmation recommended.","Discuss observation vs peeling surgery depending on symptoms.","Monitor distortion and visual acuity."]
  },
  "VitreousDetachment": {
    overview: "Age-related gel separation can cause floaters or flashes.",
    tips: ["Rule out retinal tear with a clinician if symptomatic.","Follow return precautions if new symptoms occur.","Use protective behavior until cleared."]
  },
  "Other": {
    overview: "The pattern does not map cleanly to known classes here.",
    tips: ["Request professional evaluation for tailored diagnosis.","Provide high-quality images or clinical history.","Consider alternate imaging modalities."]
  }
};

// TTS
let TTS_ENABLED = false;
const speak = (text) => {
  if (!TTS_ENABLED) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
  window.speechSynthesis.speak(u);
};
const stopSpeak = () => window.speechSynthesis.cancel();
const live = (msg) => { const el = document.getElementById('live'); el.textContent = msg; if (TTS_ENABLED) speak(msg); };

/* =============================== UI CONTROLS =============================== */
const ttsToggle = document.getElementById('ttsToggle');
ttsToggle.addEventListener('click', () => {
  TTS_ENABLED = !TTS_ENABLED;
  ttsToggle.setAttribute('aria-pressed', String(TTS_ENABLED));
  ttsToggle.textContent = TTS_ENABLED ? "üîä TTS: On" : "üîä TTS: Off";
  live(`Text to speech ${TTS_ENABLED ? 'enabled' : 'disabled'}.`);
});
document.getElementById('stopTTS').addEventListener('click', stopSpeak);

document.getElementById('contrastToggle').addEventListener('click', (e) => {
  const cur = document.body.getAttribute('data-contrast');
  const next = cur === 'high' ? 'normal' : 'high';
  document.body.setAttribute('data-contrast', next);
  e.currentTarget.setAttribute('aria-pressed', String(next === 'high'));
  live(`High contrast ${next === 'high' ? 'enabled' : 'disabled'}.`);
});
document.getElementById('fontSize').addEventListener('change', (e) => {
  document.body.style.fontSize = e.target.value + 'px';
  live(`Font size set to ${e.target.selectedOptions[0].textContent}.`);
});

// Section read buttons
const readBtns = [
  ["readModel","modelPanel"],
  ["readModes","modesTitle"],
  ["readResults","resultsTitle"],
  ["readSummary","summaryTitle"],
  ["readProbs","probsTitle"],
  ["readRecs","recsTitle"]
];
readBtns.forEach(([btnId, tgtId]) => {
  const btn = document.getElementById(btnId);
  btn.addEventListener('click', () => {
    const node = document.getElementById(tgtId);
    let txt = "";
    if (node) {
      if (node.closest('.panel')) txt = node.closest('.panel').innerText;
      else txt = node.innerText;
    }
    speak(txt);
  });
});

/* =============================== TABS / MODES ============================== */
const tabs = [
  {tab:"tabCamera", panel:"panelCamera"},
  {tab:"tabUpload", panel:"panelUpload"},
  {tab:"tabManual", panel:"panelManual"},
];
tabs.forEach(({tab,panel})=>{
  const t = document.getElementById(tab);
  const p = document.getElementById(panel);
  t.addEventListener('click', ()=>{
    tabs.forEach(({tab:tb,panel:pn})=>{
      document.getElementById(tb).setAttribute('aria-selected', String(tb===tab));
      const el = document.getElementById(pn);
      if (pn===panel) el.removeAttribute('hidden'); else el.setAttribute('hidden','');
    });
    live(`${t.textContent.trim()} mode selected.`);
  });
});

/* ============================== MODEL LOADING ============================== */
const thr = document.getElementById('thr');
const thrVal = document.getElementById('thrVal');
const thrSummary = document.getElementById('thrSummary');
thr.addEventListener('input', ()=>{
  const v = (thr.valueAsNumber/100).toFixed(2);
  thrVal.textContent = v; thrSummary.textContent = v;
});

let session = null;
let provider = 'wasm';
const modelStatus = document.getElementById('modelStatus');
const provElm = document.getElementById('prov'), opsetElm = document.getElementById('opset'), graphElm = document.getElementById('graphopt');

async function loadModelFromBuffer(arrayBuffer){
  modelStatus.textContent = "Loading model‚Ä¶";
  const t0 = performance.now();
  // Prefer WASM for compatibility; ORT auto-detects SIMD/threads.
  const options = {
    executionProviders: ['wasm'], // you can add 'webgl' if desired
    graphOptimizationLevel: 'all'
  };
  session = await ort.InferenceSession.create(arrayBuffer, options);
  provider = session.executionProvider || 'wasm';
  const dt = (performance.now()-t0).toFixed(0);
  modelStatus.textContent = "Model: loaded";
  provElm.textContent = `Provider: ${provider}`;
  graphElm.textContent = `GraphOpt: all`;
  // Opset cannot be directly read; leave N/A unless we parse the model
  opsetElm.textContent = `Opset: ‚Äî`;
  live(`Model loaded in ${dt} milliseconds using ${provider}.`);
}

document.getElementById('loadModelBtn').addEventListener('click', async ()=>{
  try{
    const fileInput = document.getElementById('modelFile');
    const urlInput = document.getElementById('modelUrl').value.trim();
    if (fileInput.files && fileInput.files[0]){
      const buf = await fileInput.files[0].arrayBuffer();
      await loadModelFromBuffer(buf);
    } else if (urlInput){
      const res = await fetch(urlInput);
      if(!res.ok) throw new Error(`Fetch failed: ${res.status}`);
      const buf = await res.arrayBuffer();
      await loadModelFromBuffer(buf);
    } else {
      alert("Select a local ONNX file or enter a URL.");
    }
  }catch(err){
    console.error(err);
    modelStatus.textContent = "Model: error";
    live("Model load failed.");
    alert("Model load failed: " + err.message);
  }
});

/* =============================== CAMERA MODE ================================ */
const video = document.getElementById('video');
const canvasCam = document.getElementById('canvasCam');
const ctxCam = canvasCam.getContext('2d');
const cameraSelect = document.getElementById('cameraSelect');
let stream = null;

async function listCameras(){
  const devices = await navigator.mediaDevices.enumerateDevices();
  const cams = devices.filter(d=>d.kind==='videoinput');
  cameraSelect.innerHTML = '';
  cams.forEach((c, i)=>{
    const opt = document.createElement('option');
    opt.value = c.deviceId; opt.textContent = c.label || `Camera ${i+1}`;
    cameraSelect.appendChild(opt);
  });
}
async function startCamera(){
  try{
    if (stream){ stream.getTracks().forEach(t=>t.stop()); }
    stream = await navigator.mediaDevices.getUserMedia({
      video: { deviceId: cameraSelect.value ? {exact: cameraSelect.value} : undefined, width:1280, height:720 }
    });
    video.srcObject = stream;
    live("Camera started.");
  }catch(err){
    alert("Camera error: " + err.message);
  }
}
document.getElementById('startCam').addEventListener('click', startCamera);
document.getElementById('stopCam').addEventListener('click', ()=>{
  if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; live("Camera stopped."); }
});
document.getElementById('snap').addEventListener('click', ()=>{
  if (!video.videoWidth){ alert("Camera not ready."); return; }
  canvasCam.width = video.videoWidth; canvasCam.height = video.videoHeight;
  ctxCam.drawImage(video, 0, 0);
  live("Image captured from camera.");
});
navigator.mediaDevices?.getUserMedia && listCameras().catch(()=>{});

/* =============================== UPLOAD MODE ================================ */
const imgFile = document.getElementById('imgFile');
const imgPreview = document.getElementById('imgPreview');
imgFile.addEventListener('change', ()=>{
  const f = imgFile.files?.[0]; if (!f) return;
  const url = URL.createObjectURL(f);
  imgPreview.src = url;
  imgPreview.onload = ()=> URL.revokeObjectURL(url);
  live("Image selected for upload.");
});

/* ============================ MANUAL MODE (TTS) ============================= */
const manualSelect = document.getElementById('manualSelect');
CLASSES.forEach(c=>{
  const o = document.createElement('option'); o.value=c; o.textContent=c; manualSelect.appendChild(o);
});
document.getElementById('manualExplain').addEventListener('click', ()=>{
  const v = manualSelect.value;
  if (!v){ alert("Select a condition first."); return; }
  renderResultsFromManual(v);
});

/* ============================ PREPROCESS / INFER ============================ */
// The training used: Resize(384,384), ToTensor(), no normalization ‚Üí scale to [0,1].
const TARGET = 384;
function preprocessImageToTensor(img){
  // Stretch to 384x384 (matches training Resize; no aspect preservation)
  const off = document.createElement('canvas');
  off.width = TARGET; off.height = TARGET;
  const ictx = off.getContext('2d');
  ictx.drawImage(img, 0, 0, TARGET, TARGET);
  const {data} = ictx.getImageData(0,0,TARGET,TARGET);
  // NCHW float32
  const chw = new Float32Array(3 * TARGET * TARGET);
  let p = 0;
  const stride = TARGET * TARGET;
  for (let i=0;i<data.length;i+=4){
    const r = data[i]   / 255.0;
    const g = data[i+1] / 255.0;
    const b = data[i+2] / 255.0;
    const idx = i>>2;
    chw[idx] = r;
    chw[idx + stride] = g;
    chw[idx + 2*stride] = b;
    p++;
  }
  const tensor = new ort.Tensor('float32', chw, [1,3,TARGET,TARGET]);
  return {tensor, info:`${img.naturalWidth||img.width}√ó${img.naturalHeight||img.height} ‚Üí 384√ó384`};
}
function sigmoid(x){ return 1/(1+Math.exp(-x)); }
function softmax(arr){
  const m = Math.max(...arr); const exps = arr.map(v=>Math.exp(v-m));
  const s = exps.reduce((a,b)=>a+b,0); return exps.map(v=>v/s);
}
function entropy(probs){ // Shannon entropy (base e)
  let e=0; for(const p of probs){ const q=Math.min(Math.max(p,1e-9),1-1e-9); e += -q*Math.log(q) - (1-q)*Math.log(1-q); }
  return e;
}
function topK(arr, k=2){
  const idx = arr.map((v,i)=>[v,i]).sort((a,b)=>b[0]-a[0]).slice(0,k);
  return idx;
}

let lastLatency = null;

async function runInferenceFromCanvas(){
  if (!session){ alert("Load the model first."); return; }
  // create an Image object from canvas
  const img = new Image();
  img.src = canvasCam.toDataURL('image/png');
  await img.decode();
  const {tensor, info} = preprocessImageToTensor(img);
  return await runModel(tensor, info);
}
async function runInferenceFromUpload(){
  if (!session){ alert("Load the model first."); return; }
  if (!imgPreview.src){ alert("Upload an image first."); return; }
  const img = imgPreview;
  const {tensor, info} = preprocessImageToTensor(img);
  return await runModel(tensor, info);
}

async function runModel(tensor, info){
  const t0 = performance.now();
  const feeds = { "input": tensor };
  const outputs = await session.run(feeds);
  const t1 = performance.now();
  lastLatency = (t1 - t0).toFixed(1) + " ms";
  document.getElementById('lat').textContent = `Last infer: ${lastLatency}`;
  document.getElementById('latency').textContent = lastLatency;
  document.getElementById('providerName').textContent = provider;
  if (performance && performance.memory){
    const gb = (performance.memory.usedJSHeapSize/(1024**3)).toFixed(2) + " GB";
    document.getElementById('mem').textContent = "Memory: " + gb;
  }

  // Expect output named "logits"
  const outName = Object.keys(outputs)[0];
  const logits = outputs[outName].data;
  // Multi-label ‚Üí sigmoid per class
  const probs = Array.from(logits, v=>sigmoid(v));
  renderResultsFromProbs(probs, info);
  return probs;
}

document.getElementById('analyzeCam').addEventListener('click', async ()=>{
  const probs = await runInferenceFromCanvas().catch(err => alert("Inference error: "+err.message));
});
document.getElementById('analyzeUpload').addEventListener('click', async ()=>{
  const probs = await runInferenceFromUpload().catch(err => alert("Inference error: "+err.message));
});

/* ============================== RENDER RESULTS ============================== */
let chart = null;
function ensureChart(ctx){
  if (chart){ chart.destroy(); chart=null; }
  chart = new Chart(ctx, {
    type:'bar',
    data:{ labels: CLASSES, datasets: [{ label:'Probability', data: new Array(CLASSES.length).fill(0) }]},
    options:{
      animation:{ duration: 300 },
      responsive:true,
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=> `${c.raw.toFixed(3)}` } } },
      scales:{
        y:{ min:0, max:1, grid:{color:'#1b2345'}, ticks:{ color:'#cfe2ff' } },
        x:{ grid:{display:false}, ticks:{ color:'#cfe2ff', maxRotation:60, minRotation:0 } }
      }
    }
  });
  return chart;
}

function renderResultsFromManual(cls){
  const probs = CLASSES.map(c => c===cls ? 0.95 : 0.05/(CLASSES.length-1));
  renderResultsFromProbs(probs, "manual");
}

function renderResultsFromProbs(probs, imgInfo){
  // Update chart and table
  const ctx = document.getElementById('probChart').getContext('2d');
  ensureChart(ctx);
  chart.data.datasets[0].data = probs;
  chart.update();

  const tb = document.getElementById('probTable').querySelector('tbody');
  tb.innerHTML = '';
  probs.forEach((p,i)=>{
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = CLASSES[i]; tr.appendChild(td1);
    const td2 = document.createElement('td'); td2.textContent = (p*100).toFixed(2) + "%"; tr.appendChild(td2);
    tb.appendChild(tr);
  });

  const thrVal = Number(document.getElementById('thr').value)/100;
  const top = topK(probs,2);
  const topIdx = top[0][1], topP = top[0][0], secondP = top[1][0];
  const over = probs.map((p,i)=> p>=thrVal ? CLASSES[i] : null).filter(Boolean);

  document.getElementById('topClass').textContent = `${CLASSES[topIdx]}`;
  document.getElementById('topConf').textContent = (topP*100).toFixed(2) + "%";
  document.getElementById('confMeter').style.width = Math.round(topP*100)+'%';
  document.getElementById('aboveThr').textContent = over.length ? over.join(", ") : "None";
  const H = entropy(probs);
  document.getElementById('entropy').textContent = H.toFixed(3);
  document.getElementById('margin').textContent = (topP - secondP).toFixed(3);
  document.getElementById('thrSummary').textContent = thrVal.toFixed(2);
  document.getElementById('imgInfo').textContent = imgInfo || "‚Äî";

  // Recommendations & Overview
  const cls = CLASSES[topIdx];
  renderRecs(cls, probs, over, thrVal);

  // Announce
  live(`Analysis complete. Top class ${cls} with ${(topP*100).toFixed(1)} percent. ${over.length} classes above threshold.`);
}

function renderRecs(cls, probs, over, thrVal){
  const div = document.getElementById('recsBody');
  const explain = EXPLAINS[cls] || EXPLAINS["Other"];
  const list = explain.tips.map(t=>`<li>${t}</li>`).join("");
  const tableRows = CLASSES.map((c,i)=>`<tr><td>${c}</td><td>${(probs[i]*100).toFixed(2)}%</td><td>${probs[i] >= thrVal ? "‚úì" : "‚Äî"}</td></tr>`).join("");

  div.innerHTML = `
    <article aria-label="Detailed recommendations and overview">
      <p><strong>Class focus:</strong> ${cls}</p>
      <p><strong>Overview:</strong> ${explain.overview}</p>
      <p><strong>General guidance:</strong></p>
      <ul>${list}</ul>
      <details>
        <summary>Show full probability table</summary>
        <table aria-label="Full probability table with threshold flags">
          <thead><tr><th>Class</th><th>Probability</th><th>Above threshold?</th></tr></thead>
          <tbody>${tableRows}</tbody>
        </table>
      </details>
      <p class="warning"><strong>Disclaimer:</strong> This demo is for education only. It does not diagnose conditions. Always seek professional evaluation for symptoms, screening, or treatment decisions.</p>
    </article>
  `;
}

/* =========================== BUTTON BINDINGS ================================ */
document.getElementById('readModel').addEventListener('click', ()=> speak(document.getElementById('modelPanel').innerText));
document.getElementById('readModes').addEventListener('click', ()=> speak(document.getElementById('modesTitle').closest('.panel').innerText));
document.getElementById('readResults').addEventListener('click', ()=> speak(document.getElementById('main').innerText));

/* ============== ACCESSIBLE KEYBOARD SHORTCUTS (OPTIONAL) ==================== */
document.addEventListener('keydown', (e)=>{
  if (e.altKey || e.ctrlKey || e.metaKey) return;
  if (e.key === 'c'){ document.getElementById('tabCamera').click(); }
  if (e.key === 'u'){ document.getElementById('tabUpload').click(); }
  if (e.key === 'm'){ document.getElementById('tabManual').click(); }
  if (e.key === 't'){ ttsToggle.click(); }
});

/* ============================== ANALYZE HOOKS =============================== */
document.getElementById('snap').addEventListener('click', ()=> {
  // After taking picture, pre-fill image info:
  document.getElementById('imgInfo').textContent = "Camera capture";
});

</script>
</body>
</html>
